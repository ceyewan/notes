# APDU 指令集实现

本部分，我们需要在安全芯片上实现以下几种 **APDU** **指令集。首先，就是兼容传统协议的** **APDU** **指令集，可以通过该指令集去读取护照中的信息并验证数据的签名。其次，针对本作品设计的** **PQ-APDU** **协议和** **PQ-AA** **协议，需要设计一套后量子** **APDU** **指令集，用于支持这两个新的协议。最后，验证终端需要能够监视安全芯片上的处理流程，获取安全芯片上的处理结果，这也需要一套** **APDU** **指令集。接下来，是这三种** **APDU** **指令集的详细实现。

## 1 传统协议 APDU 指令集实现

---

### 1.1 **1. 选择护照应用**

| **字段**   | **值**                                                    | **说明**                                           |
| -------- | -------------------------------------------------------- | ------------------------------------------------ |
| **命令头**  | CLA: 0x00, INS: 0xA4                                     | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xA4 表示 SELECT） |
| **参数**   | P1: 0x04, P2: 0x0C                                       | P1: 选择方式（0x04 表示按名称选择），P2: 保留为 0x0C              |
| **命令体**  | Lc: 0x07, Data: 0xA0, 0x00, 0x00, 0x02, 0x47, 0x10, 0x01 | Lc: 数据长度（7 字节），Data: 应用标识符（AID）                  |
| **响应数据** | -                                                        | 无响应数据                                            |
| **响应状态** | SW1: 0x90, SW2: 0x00                                     | SW1 和 SW2: 响应状态码（0x9000 表示成功）                    |

**作用**: 选择护照应用，以便后续操作。

---

### 1.2 **2. 获取挑战值 (GET CHALLENGE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0x84 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0x84 表示 GET CHALLENGE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x00, Le: 0x08   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（8 字节）         |
| **响应数据** | Data: 8 字节随机数       | 卡片生成的 8 字节随机数                                |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 获取卡片生成的 8 字节随机数，用于后续的 BAC 认证。

---

### 1.3 **3. 外部认证 (EXTERNAL AUTHENTICATE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0x82 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0x82 表示 EXTERNAL AUTHENTICATE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x28, Data: 加密数据 + MAC | Lc: 数据长度（40 字节），Data: 加密数据和 MAC 值             |
| **响应数据** | Data: 加密数据 + MAC   | 卡片返回的加密数据和 MAC 值                             |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 执行外部认证，验证卡片和终端之间的 BAC 认证。

---

### 1.4 **4. 选择文件 (SELECT FILE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xA4 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xA4 表示 SELECT） |
| **参数**   | P1: 0x02, P2: 0x0C   | P1: 选择方式（0x02 表示按文件 ID 选择），P2: 保留为 0x0C         |
| **命令体**  | Lc: 0x02, Data: 文件 ID | Lc: 数据长度（2 字节），Data: 文件 ID                     |
| **响应数据** | -                    | 无响应数据                                         |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 选择指定的文件（如 EF.COM、EF.DG1 等），以便后续读取文件内容。

---

### 1.5 **5. 读取二进制文件 (READ BINARY)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xB0 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xB0 表示 READ BINARY） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 文件偏移量（0x00 表示从文件开头读取）                 |
| **命令体**  | Lc: 0x00, Le: 0x04   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（4 字节）         |
| **响应数据** | Data: 文件内容         | 读取的文件内容                                     |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 读取指定文件的二进制内容。

---

### 1.6 **6. 内部认证 (INTERNAL AUTHENTICATE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0x88 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0x88 表示 INTERNAL AUTHENTICATE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x08, Data: 随机数 | Lc: 数据长度（8 字节），Data: 终端生成的 8 字节随机数          |
| **响应数据** | Data: 签名数据         | 卡片返回的签名数据                                   |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 执行内部认证，验证卡片的签名数据。

---

这些 APDU 指令集涵盖了护照读取和认证的主要流程，包括选择应用、获取挑战值、外部认证、选择文件、读取文件、内部认证。

以下是一套详实的 APDU 命令和应答设计，使用表格表示，覆盖了 PC 验证终端与安全芯片之间的几种典型通信场景。这些场景包括查询护照状态、读取护照信息、启动认证、获取认证结果等。

---

## 2 后量子协议 APDU 指令集实现

## 3 验证终端通信 APDU 指令集实现

### 3.1 **1. 查询护照状态**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xA1 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xA1 表示查询状态） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 指令参数（保留为 0x00）                       |
| **命令体**  | Lc: 0x00, Le: 0x01   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（1 字节）             |
| **响应数据** | Data: 0x01           | 0x01: 护照已插入，0x00: 护照未插入                       |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

---

### 3.2 **2. 读取护照信息**

| **字段**       | **值**               | **说明**                                                                 |
|----------------|----------------------|--------------------------------------------------------------------------|
| **命令头**     | CLA: 0x00, INS: 0xB2 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xB2 表示读取信息） |
| **参数**       | P1: 0x00, P2: 0x00   | P1 和 P2: 指令参数（保留为 0x00）                                      |
| **命令体**     | Lc: 0x00, Le: 0x40   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（64 字节）              |
| **响应数据**   | Data: 64 字节        | 护照信息（如姓名、护照号、有效期等）                                   |
| **响应状态**   | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                              |

---

### 3.3 **4. 查询认证进度**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xD4 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xD4 表示查询进度） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 指令参数（保留为 0x00）                       |
| **命令体**  | Lc: 0x00, Le: 0x01   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（1 字节）             |
| **响应数据** | Data: 0x50           | 0x50: 认证进度（百分比，0x50 表示 80%）                   |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

---

### 3.4 **5. 获取认证结果**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xE5 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xE5 表示获取结果） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 指令参数（保留为 0x00）                       |
| **命令体**  | Lc: 0x00, Le: 0x01   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（1 字节）             |
| **响应数据** | Data: 0x01           | 0x01: 认证成功，0x00: 认证失败                         |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

---
