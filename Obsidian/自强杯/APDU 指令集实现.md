# APDU 指令集实现

本部分详细描述了在安全芯片上实现的三套 **APDU** **指令集**。第一套是兼容传统协议的 **APDU** **指令集**，用于读取护照中的信息并验证数据的签名。第二套是针对后量子密码学设计的 **PQ-APDU** **协议** 和 **PQ-AA** **协议** 的 **APDU** **指令集**，用于支持后量子密码学协议。第三套是用于验证终端与安全芯片之间通信的 **APDU** **指令集**，用于监视安全芯片的处理流程并获取处理结果。以下是这三套 **APDU** **指令集** 的详细实现。

---

## 1 传统协议 APDU 指令集实现

### 1.1 **1. 选择护照应用**

| **字段**   | **值**                                                    | **说明**                                           |
| -------- | -------------------------------------------------------- | ------------------------------------------------ |
| **命令头**  | CLA: 0x00, INS: 0xA4                                     | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xA4 表示 SELECT） |
| **参数**   | P1: 0x04, P2: 0x0C                                       | P1: 选择方式（0x04 表示按名称选择），P2: 保留为 0x0C              |
| **命令体**  | Lc: 0x07, Data: 0xA0, 0x00, 0x00, 0x02, 0x47, 0x10, 0x01 | Lc: 数据长度（7 字节），Data: 应用标识符（AID）                  |
| **响应数据** | -                                                        | 无响应数据                                            |
| **响应状态** | SW1: 0x90, SW2: 0x00                                     | SW1 和 SW2: 响应状态码（0x9000 表示成功）                    |

**作用**: 该指令用于选择护照应用，以便后续操作。通过指定应用标识符（AID），安全芯片可以识别并激活护照应用，确保后续的指令能够正确执行。选择应用是读取护照信息的第一步，只有在成功选择应用后，才能进行后续的读取和认证操作。

---

### 1.2 **2. 获取挑战值 (GET CHALLENGE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0x84 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0x84 表示 GET CHALLENGE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x00, Le: 0x08   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（8 字节）         |
| **响应数据** | Data: 8 字节随机数       | 卡片生成的 8 字节随机数                                |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于获取安全芯片生成的 8 字节随机数，该随机数将用于后续的 **BAC**（基本访问控制）认证流程。**BAC** 认证是护照与阅读机之间的双向认证过程，挑战值的获取是认证流程的第一步。通过该指令，终端可以获取芯片生成的随机数，并基于该随机数生成认证所需的加密数据。

---

### 1.3 **3. 外部认证 (EXTERNAL AUTHENTICATE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0x82 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0x82 表示 EXTERNAL AUTHENTICATE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x28, Data: 加密数据 + MAC | Lc: 数据长度（40 字节），Data: 加密数据和 MAC 值             |
| **响应数据** | Data: 加密数据 + MAC   | 卡片返回的加密数据和 MAC 值                             |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于执行外部认证，验证终端与安全芯片之间的 **BAC** 认证。终端将基于挑战值生成的加密数据和 **MAC** 值发送给芯片，芯片验证数据的合法性并返回相应的加密数据和 **MAC** 值。外部认证是 **BAC** 认证的核心步骤，确保终端与芯片之间的通信是安全且可信的。

---

### 1.4 **4. 选择文件 (SELECT FILE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xA4 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xA4 表示 SELECT） |
| **参数**   | P1: 0x02, P2: 0x0C   | P1: 选择方式（0x02 表示按文件 ID 选择），P2: 保留为 0x0C         |
| **命令体**  | Lc: 0x02, Data: 文件 ID | Lc: 数据长度（2 字节），Data: 文件 ID                     |
| **响应数据** | -                    | 无响应数据                                         |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于选择指定的文件（如 **EF.COM**、**EF.DG1** 等），以便后续读取文件内容。护照中的数据通常存储在多个文件中，每个文件包含不同的信息（如个人信息、照片等）。通过该指令，终端可以选择特定的文件，确保后续的读取操作能够正确执行。

---

### 1.5 **5. 读取二进制文件 (READ BINARY)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xB0 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xB0 表示 READ BINARY） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 文件偏移量（0x00 表示从文件开头读取）                 |
| **命令体**  | Lc: 0x00, Le: 0x04   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（4 字节）         |
| **响应数据** | Data: 文件内容         | 读取的文件内容                                     |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于读取指定文件的二进制内容。通过指定文件偏移量和期望的读取长度，终端可以从选定的文件中读取数据。读取的文件内容可能包含护照持有人的个人信息、照片等数据，这些数据将用于后续的验证和处理。

---

### 1.6 **6. 内部认证 (INTERNAL AUTHENTICATE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0x88 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0x88 表示 INTERNAL AUTHENTICATE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x08, Data: 随机数 | Lc: 数据长度（8 字节），Data: 终端生成的 8 字节随机数          |
| **响应数据** | Data: 签名数据         | 卡片返回的签名数据                                   |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于执行内部认证，验证安全芯片的签名数据。终端生成一个随机数并发送给芯片，芯片基于该随机数生成签名数据并返回给终端。终端可以通过验证签名数据来确认芯片的合法性和数据的完整性。

---

## 2 后量子协议 APDU 指令集实现

### 2.1 **1. 选择后量子应用**

| **字段**   | **值**                                                    | **说明**                                           |
| -------- | -------------------------------------------------------- | ------------------------------------------------ |
| **命令头**  | CLA: 0x80, INS: 0xA4                                     | CLA: 命令类别（0x80 表示后量子命令），INS: 指令代码（0xA4 表示 SELECT） |
| **参数**   | P1: 0x04, P2: 0x0C                                       | P1: 选择方式（0x04 表示按名称选择），P2: 保留为 0x0C              |
| **命令体**  | Lc: 0x07, Data: 0xA0, 0x00, 0x00, 0x02, 0x47, 0x10, 0x02 | Lc: 数据长度（7 字节），Data: 后量子应用标识符（AID）                  |
| **响应数据** | -                                                        | 无响应数据                                            |
| **响应状态** | SW1: 0x90, SW2: 0x00                                     | SW1 和 SW2: 响应状态码（0x9000 表示成功）                    |

**作用**: 该指令用于选择后量子应用，以便后续操作。通过指定后量子应用标识符（AID），安全芯片可以识别并激活后量子应用，确保后续的指令能够正确执行。

---

### 2.2 **2. 获取后量子挑战值 (GET PQ-CHALLENGE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x80, INS: 0x84 | CLA: 命令类别（0x80 表示后量子命令），INS: 指令代码（0x84 表示 GET PQ-CHALLENGE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x00, Le: 0x20   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（32 字节）         |
| **响应数据** | Data: 32 字节随机数       | 卡片生成的 32 字节随机数                                |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于获取安全芯片生成的 32 字节随机数，该随机数将用于后续的 **PQ-PACE** 认证流程。**PQ-PACE** 是后量子密码学协议，挑战值的获取是认证流程的第一步。

---

### 2.3 **3. 后量子外部认证 (PQ-EXTERNAL AUTHENTICATE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x80, INS: 0x82 | CLA: 命令类别（0x80 表示后量子命令），INS: 指令代码（0x82 表示 PQ-EXTERNAL AUTHENTICATE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x40, Data: 加密数据 + MAC | Lc: 数据长度（64 字节），Data: 加密数据和 MAC 值             |
| **响应数据** | Data: 加密数据 + MAC   | 卡片返回的加密数据和 MAC 值                             |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于执行后量子外部认证，验证终端与安全芯片之间的 **PQ-PACE** 认证。终端将基于挑战值生成的加密数据和 **MAC** 值发送给芯片，芯片验证数据的合法性并返回相应的加密数据和 **MAC** 值。

---

### 2.4 **4. 后量子内部认证 (PQ-INTERNAL AUTHENTICATE)**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x80, INS: 0x88 | CLA: 命令类别（0x80 表示后量子命令），INS: 指令代码（0x88 表示 PQ-INTERNAL AUTHENTICATE） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 保留为 0x00                               |
| **命令体**  | Lc: 0x20, Data: 随机数 | Lc: 数据长度（32 字节），Data: 终端生成的 32 字节随机数          |
| **响应数据** | Data: 签名数据         | 卡片返回的签名数据                                   |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于执行后量子内部认证，验证安全芯片的签名数据。终端生成一个随机数并发送给芯片，芯片基于该随机数生成签名数据并返回给终端。

---

## 3 验证终端通信 APDU 指令集实现

### 3.1 **1. 查询护照状态**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xA1 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xA1 表示查询状态） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 指令参数（保留为 0x00）                       |
| **命令体**  | Lc: 0x00, Le: 0x01   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（1 字节）             |
| **响应数据** | Data: 0x01           | 0x01: 护照已插入，0x00: 护照未插入                       |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于查询护照的插入状态。验证终端可以通过该指令轮询安全芯片，确认是否有护照插入。该指令的响应数据为 1 字节，0x01 表示护照已插入，0x00 表示护照未插入。

---

### 3.2 **2. 读取护照信息**

| **字段**       | **值**               | **说明**                                                                 |
|----------------|----------------------|--------------------------------------------------------------------------|
| **命令头**     | CLA: 0x00, INS: 0xB2 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xB2 表示读取信息） |
| **参数**       | P1: 0x00, P2: 0x00   | P1 和 P2: 指令参数（保留为 0x00）                                      |
| **命令体**     | Lc: 0x00, Le: 0x40   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（64 字节）              |
| **响应数据**   | Data: 64 字节        | 护照信息（如姓名、护照号、有效期等）                                   |
| **响应状态**   | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                              |

**作用**: 该指令用于读取护照的基本信息。验证终端可以通过该指令从安全芯片中读取护照持有人的姓名、护照号、有效期等信息。该指令的响应数据为 64 字节，包含护照的基本信息。

---

### 3.3 **3. 查询认证进度**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xD4 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xD4 表示查询进度） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 指令参数（保留为 0x00）                       |
| **命令体**  | Lc: 0x00, Le: 0x01   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（1 字节）             |
| **响应数据** | Data: 0x50           | 0x50: 认证进度（百分比，0x50 表示 80%）                   |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于查询认证的进度。验证终端可以通过该指令获取当前认证流程的进度百分比。该指令的响应数据为 1 字节，表示认证进度的百分比。

---

### 3.4 **4. 获取认证结果**

| **字段**   | **值**                | **说明**                                        |
| -------- | -------------------- | --------------------------------------------- |
| **命令头**  | CLA: 0x00, INS: 0xE5 | CLA: 命令类别（0x00 表示标准命令），INS: 指令代码（0xE5 表示获取结果） |
| **参数**   | P1: 0x00, P2: 0x00   | P1 和 P2: 指令参数（保留为 0x00）                       |
| **命令体**  | Lc: 0x00, Le: 0x01   | Lc: 数据长度（无数据），Le: 期望的响应数据长度（1 字节）             |
| **响应数据** | Data: 0x01           | 0x01: 认证成功，0x00: 认证失败                         |
| **响应状态** | SW1: 0x90, SW2: 0x00 | SW1 和 SW2: 响应状态码（0x9000 表示成功）                 |

**作用**: 该指令用于获取认证的结果。验证终端可以通过该指令确认认证是否成功。该指令的响应数据为 1 字节，0x01 表示认证成功，0x00 表示认证失败。

---

以上三套 **APDU** **指令集** 涵盖了传统协议、后量子协议以及验证终端与安全芯片之间的通信需求，确保系统能够安全、高效地读取和验证护照信息。
