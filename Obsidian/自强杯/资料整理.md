## 1 术语概念

1. **电子机读旅行证件**：电子机读旅行证件（Machine Readable Travel Document, MRTD）是指任何包含机读功能的旅行证件，包括但不限于护照、签证、身份证等。电子护照是 MRTD 的一种特例。
2. **电子护照**：电子护照（e-Passport）是一种内置有非接触式智能卡芯片的旅行证件，该芯片通过 RFID 或 NFC 技术存储并传输持有者的个人信息和生物识别数据。
3. **机读区**：机读区（Machine Readable Zone, MRZ）是旅行证件上的一块专用区域，使用机器可读的格式打印个人信息，旨在提高自动化识别和验证的效率。
4. **电子护照阅读机**：电子护照阅读机（e-Passport Reader）是用于读取电子护照内芯片和机读区信息的专用设备，包含光学扫描、RFID/NFC 读取、密码运算与验证等功能模块。

## 2 MRZ

MRZ 是护照或身份证件上的一块区域，通常位于护照资料页的底部。根据国际民航组织（ICAO）Doc 9303 标准，MRZ 的主要特点是：
- 采用 **OCR-B 字体**（机器可读的标准化字体），便于扫描和识别。
- **字符限制**：仅使用字母（A-Z）、数字（0-9）和特殊符号 <（作为填充符）。
- **机器和人工可读**：可通过电子阅读器快速识别，同时肉眼可以核对内容。

最常见的 MRZ 格式为 TD3，用于国际护照。其格式分为两行，每行 44 个字符，如下图所示。

![image.png](https://ceyewan.oss-cn-beijing.aliyuncs.com/typora/20250118095523.png)

第一行：

| 位置   | 长度  | 字符     | 意义                 |
| ---- | --- | ------ | ------------------ |
| 1    | 1   | 字母     | P 代表护照、V 代表签证等     |
| 2    | 1   | 字母或填充符 | P 代表普通护照、O 代表公务护照等 |
| 3-5  | 3   | 字母     | 签发国家或地区代码          |
| 6-44 | 39  | 字母或填充符 | 英文姓名，使用两个填充符对姓名分隔  |

第二行：

| 位置    | 长度  | 字符     | 意义                      |
| ----- | --- | ------ | ----------------------- |
| 1–9   | 9   | 字母或数字  | 护照号                     |
| 10    | 1   | 数字     | 护照号的校验位                 |
| 11–13 | 3   | 字母     | 国籍代码（ISO 3166-1 标准）      |
| 14–19 | 6   | 数字     | 出生日期（YYMMDD）            |
| 20    | 1   | 字母     | 生日的校验位                  |
| 21    | 1   | 字母或填充符 | 性别（M、F 或填充符；表示男性，女性或不详） |
| 22–27 | 6   | 数字     | 护照有效期（YYMMDD）           |
| 28    | 1   | 数字     | 护照有效期的校验位               |
| 29–42 | 14  | 字母或数字  | 可选字段，可以是个人身份证号码或其他信息    |
| 43    | 1   | 数字     | 个人号码的校验位                |
| 44    | 1   | 数字     | 第二行 1-10，14-20，22-43 的验证位 |
校验位的计算逻辑：

```python
def compute_mrz_checksum(source): 
	s = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ" 
	w = [7, 3, 1] 
	c = 0 
	for i, char in enumerate(source): 
		if char == '<': continue # 跳过填充符 '<' 
		c += s.index(char) * w[i % 3] # 字符的索引乘以对应的权重 
	c %= 10 # 取模运算 
	return c
```

## 3 认证流程

电子护照过境认证流程分为初始化、安全通道建立、数据读取、数据验证和身份验证五大阶段。涉及的密码学技术包括对称加密（DES/AES）、密钥协商协议（PACE）、数字签名验证（RSA/ECDSA），以及基于 PKI 的信任链验证。

### 3.1 初始化

当用户摊开护照时，护照阅读机会首先扫描护照的机读区（MRZ）。MRZ 是护照上的一块机器可读区域，包含护照号码、出生日期和到期日期等基础信息。这些信息不仅用于识别护照持有人的身份，还被用作生成访问密钥的基础，以确保护照阅读机与护照芯片之间的通信具有授权性和安全性。

护照阅读机会从 MRZ 中提取上述信息，并通过哈希算法（如 SHA-256）对其进行处理，派生出一个 256 位的会话密钥。这个会话密钥分为两部分：**Kenc** 和 **Kmac**。其中，Kenc 用于加密护照阅读机与芯片之间的通信数据，确保信息的机密性；Kmac 则用于消息完整性验证，确保通信过程中的数据未被篡改。

在完成密钥生成后，护照阅读机通过射频信号激活护照芯片。芯片在接收到信号后进入工作状态，并准备响应护照阅读机的认证请求。此时，护照芯片处于等待状态，随时准备与阅读机进行后续的安全认证和通信过程。

### 3.2 建立安全通道

护照阅读机与电子护照芯片之间需要进行密钥协商，以建立加密通信通道。这一过程可以通过 **BAC**（Basic Access Control）协议完成，或者使用更先进的 **PACE**（Password Authenticated Connection Establishment）协议。在 PACE 协议中，护照芯片和阅读机通过公钥交换生成共享的会话密钥。然而，为了防止在交换过程中公钥数据被窃取或篡改，协议引入了基于 MRZ（机器可读区）派生密钥的对称加密技术来保护公钥数据的传输。

首先，护照阅读机从护照的 MRZ 中提取护照号码、出生日期和护照有效期等字段，将这些字段拼接后进行哈希运算（SHA-256）。通过哈希运算生成一个 256 位的派生密钥，其中前 128 位被用作加密密钥 Kenc，用于加密通信；后 128 位被用作完整性验证密钥 Kmac，用于验证通信的完整性。

接下来，护照芯片和阅读机分别生成各自的临时私钥和公钥。芯片生成私钥 $ d_c $ 和公钥 $ P_c $，阅读机生成私钥 $ d_r $ 和公钥 $ P_r $。双方使用椭圆曲线 Diffie-Hellman（ECDH）算法进行密钥交换，以生成共享的会话密钥。

在密钥交换过程中，芯片使用对称加密算法 AES-256 和派生密钥 Kenc 对其公钥 $ P_c $ 进行加密，生成密文 Encrypted\_Pc，并通过射频信道将其发送给阅读机。阅读机接收到密文后，使用相同的 Kenc 解密以获取芯片的公钥 $ P_c $。阅读机进行同样的操作将公钥 $P_r$ 安装的发送到芯片端。

随后，护照芯片和阅读机根据 Diffie-Hellman 协议分别计算共享密钥。芯片使用公式 $ \text{Shared\_Secret} = d_c \cdot P_r $ 进行计算，阅读机则使用公式 $ \text{Shared\_Secret} = d_r \cdot P_c $。由于 Diffie-Hellman 算法的性质，双方计算得到的共享密钥 $ \text{Shared\_Secret} $ 是一致的。接着，双方使用密钥派生函数（KDF）对共享密钥进行进一步处理，生成用于后续通信的会话密钥，这些密钥不仅用于加密通信，还提供完整性保护。

为了确保通信的完整性，在共享密钥计算完成后，护照芯片和阅读机分别使用派生的 Kmac 对交换的信息（如 $ P_c $ 和 $ P_r $）生成 MAC 值。这一过程可以验证交换的信息是否被篡改，从而确保通信的安全性。

### 3.3 数据读取

在成功建立安全通道后，护照阅读机开始向护照芯片发送数据请求。通过安全通道，阅读机能够访问芯片内部存储的文件系统（EF 文件结构），并读取所需的数据。

护照芯片中的数据通常分为两类：基础信息和敏感信息。基础信息包括持照人的姓名、出生日期和国籍等，这些数据主要用于身份核验。而敏感信息则包括生物特征数据（如面部图像、指纹或虹膜信息）以及数字签名等，这些数据的读取需要更高的安全保护。

当护照阅读机发出数据请求后，芯片会根据请求进行响应，并将所需的数据返回给阅读机。在传输敏感数据时，芯片会使用之前协商生成的会话密钥对数据进行加密，以确保数据在传输过程中的机密性和安全性。这样，即使传输信道被监听，未经授权的第三方也无法解读数据内容。

### 3.4 数据验证

在护照阅读机成功读取芯片中存储的数据后，下一步是验证数据的完整性和真实性。数据验证的核心在于检查护照芯片中的数字签名，以确保数据未被篡改，并且由可信的签发机构生成。

护照芯片中的敏感数据通常附带一个数字签名，该签名由护照签发机构使用其私钥生成。验证过程如下：

1.  护照阅读机从护照芯片中提取数据和对应的数字签名值。
2.  阅读机使用签发机构的公钥对数字签名进行解密，并将解密后的签名值与数据进行比对。
3.  如果签名值与数据匹配，则证明数据未被篡改，且来源可信。

为了进一步确保签发机构的可信性，护照阅读机需要验证公钥的信任链。如果签发机构的公钥未直接存储在阅读机中，则需要通过证书链进行验证。具体流程如下：

1.  **文档签名证书（DSC）验证**：护照芯片附带一个 **DSC（Document Signer Certificate，文档签名证书）**，用于证明签发机构的身份。
2.  **验证 DSC 的真实性**：阅读机使用 **CSCA（国家证书签发机构）公钥**对 DSC 进行验证，确保 DSC 是由合法的国家签发机构颁发的。
3.  **信任链验证**：通过 PKI 信任链，从 CSCA 公钥到 DSC，再到护照数据，逐层验证整个证书链的可信性。

### 3.5 身份验证

**比对护照芯片数据与用户实际信息**

• 阅读机提取护照数据（如姓名、出生日期、生物特征）。

• 使用现场采集的生物特征（如面部、指纹、虹膜）与芯片数据进行比对。

**密码学技术：**

• 如果使用 **Active Authentication (AA)**：

• 芯片生成一个随机数签名，阅读机验证签名的正确性，防止伪造芯片。

• 如果使用 **Extended Access Control (EAC)**：

• 阅读机和芯片进一步交换认证信息，确保敏感生物特征仅授权设备访问。

**最终认证结果**

• 如果所有验证均通过，允许持有者过境。

• 如果验证失败，可能触发人工检查或拒绝入境。
