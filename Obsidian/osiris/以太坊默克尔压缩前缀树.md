**MPT 树**（Merkle Patricia Trie）是一种结合了  **Merkle Tree**（默克尔树）和  **Patricia Tree**（压缩前缀树）特性的树形数据结构。它的核心目标是高效地存储、验证和检索键值对数据。

* **Merkle Tree**：通过哈希逐层构建的树结构，用于验证数据的完整性。
* **Patricia Tree**：一种压缩前缀树，通过合并单子节点路径来优化存储空间。

MPT 树的设计旨在同时实现  **空间优化**、**数据验证**  和  **高效的键值存储**。

## 1 基础数据结构

### 1.1 Trie 字典树

**Trie** 是一种用于存储关联数组的树形结构，键按字符逐层分割路径。

* 键的公共前缀共享路径，节省空间。
* 查询时间复杂度与键长相关（O(L)）。

### 1.2 Merkle Tree 默克尔树

**Merkle Tree** 是一种通过哈希逐层构建的二叉树，用于高效验证数据完整性。

* 叶子节点存储数据哈希，非叶节点存储子节点哈希的拼接哈希。
* 根哈希唯一标识整棵树的状态。

### 1.3 Patricia Tree 压缩前缀树

**Patricia Tree** 是 Trie 的优化版本，通过合并单子节点路径来减少树深度。

* 通过路径压缩（合并单分支节点）降低空间复杂度。
* 支持更高效的插入和删除操作。

> 举个例子，用于直观的理解**合并单子节点路径**，左边是 Trie 中可能的结果，右边是 Patricia Tree 中对应的结构。
>
> ```
>       root                root
>      /    \              /    \
>    c       d          ca       do
>   /         \        /  \     /  \
>  a           o      t    r   g    d
> /  \        / \
> t    r     g   d
> ```

MPT 树的设计结合了 Trie、Merkle Tree 和 Patricia Tree 的需求，旨在同时实现 **空间优化**、**数据验证** 和 **高效的键值存储**。MPT 树的诞生背景正是为了解决这三者的局限性。

## 2 MPT 树核心结构

MPT 树包含四种节点类型：

1. **空节点（Null Node）**：表示空值或未初始化的节点。
2. **叶子节点（Leaf Node）**：存储键值对的最终存储单元，包含键的最后部分和值。
3. **扩展节点（Extension Node）**：一种快捷方式节点，用于表示共享前缀的压缩表示，并链接到下一个节点。
4. **分支节点（Branch Node）**：包含 16 个子分支和一个可选的 Value 值。

MPT 树使用 **Hex-Prefix（HP）编码** 来压缩键的表示，消除冗余字符，优化路径存储。每个节点的哈希值由其子节点哈希生成，根哈希唯一标识整棵树的状态。这一特性使得 MPT 树能够高效地验证数据的完整性。

## 3 以太坊中的 Tries

以太坊中，每个区块头都存储了三种 Trie 结构的根：stateRoot、transactionRoot 和 receiptsRoot。

![image.png](https://ceyewan.oss-cn-beijing.aliyuncs.com/typora/20250216133348.png)

- **State Trie**：状态树/世界状态树表示的是账户地址与账户状态之间的映射关系。账户状态包括 Balance、Nonce、CodeHash 和 StorageRoot。其中 StorageRoot 是账户存储树（存储与账户相关的合约数据）的根。**根节点依赖于所有内部数据，其哈希值作为整个系统状态的唯一标识符。** 状态根（stateRoot）是状态树根节点的哈希值，它会在每次交易执行并提交后更新。
- **Transaction Trie**：交易树基于区块内的交易列表创建，交易树中特定交易的路径是根据该交易在区块中的位置来追踪的。一旦一个区块被挖出，交易在区块中的位置不会改变，因此交易树永远不会更新。
- **Receipt Trie**：收据树记录了成功执行的交易成果，包括交易状态码、使用的 gas、交易日志和布隆过滤器（一种用于快速查找日志的数据结构）。这里的键是区块中交易的索引，值是交易收据。收据树从不更新。