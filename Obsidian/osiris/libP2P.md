libp2p 是一个去中心化网络框架，旨在简化分布式点对点（P2P）应用程序的构建。它通过提供一套模块化的网络组件，帮助开发者解决构建大规模、可靠和高效的 P2P 系统中的各种挑战。libp2p 使得开发者可以在多种传输协议、内容发现机制和身份验证方式中选择最适合的方案，从而构建高效、安全且具可扩展性的去中心化应用。

> [!NOTE] P2P
> P2P（Peer-to-Peer）网络是一种分布式网络架构，在这种架构中，所有参与节点（或设备）在网络中都是对等的，具备相同的权利和能力来提供服务、共享资源或交换信息。与传统的客户端-服务器（C/S）模型不同，P2P 网络没有中心化的服务器，所有节点既可以作为客户端也可以作为服务器。

## 1 Key Concepts

### 1.1 Transport

libp2p 使开发者能够灵活选择适合其应用需求的传输协议。传输协议位于网络栈的底层，libp2p 支持 TCP 和 QUIC 等协议，后者是一种基于 UDP 构建的高效传输协议，特别适合低延迟应用。当两个对等节点在互联网上建立连接时，它们将使用这些传输协议进行数据交换。

### 1.2 Stream Multiplexing

为了优化资源使用并减少高开销的连接建立操作，libp2p 支持流复用（stream multiplexing）。这意味着在同一个底层连接上，libp2p 可以并行地传输多种类型的数据。流复用通过将物理连接分解为多个逻辑流（每个流处理一种特定的数据类型）来实现，从而显著提高了网络通信效率。

### 1.3 NAT Traversal

在 P2P 网络中，节点通常处于 NAT 后面，这使得直接建立连接变得困难。libp2p 提供了几种 NAT 穿越机制，例如 NAT 打洞（hole punching）和中继（relay）。这些方法可以帮助节点绕过 NAT 限制，使得它们能够与其他节点建立直接连接，无论它们处于私有网络中的哪个位置。
### 1.4 Protocols

libp2p 提供了一个高度模块化的协议体系，允许开发者定义和使用各种协议进行数据交换。每个协议在 libp2p 中通过一个唯一的协议标识符来表示，这些协议可以是针对不同类型数据的处理规则。例如，两个对等节点 A 和 B 之间的通信可能会包括多个协议，其中 A 打开一个用于协议 xxx 的流，B 则为该协议创建处理器来接收并管理消息。通过这种机制，libp2p 支持多种数据格式和协议的并行处理。

### 1.5 Peer Identity

在去中心化的 P2P 网络中，每个节点必须具有唯一的身份。libp2p 通过对等节点 ID 来实现这一点，该 ID 是从对等节点的私钥派生出来的 multihash（多重哈希）标识符。该身份标识符是网络中对等节点的唯一证明，用于确保节点的身份在通信过程中得到验证。

### 1.6 Addressing

libp2p 使用一种称为“多地址”（multiaddress）的寻址机制，允许节点通过多个协议栈进行通信。多地址不仅仅是 IP 地址，它还可以包括传输协议、端口号以及其他上下文信息，确保节点在复杂的网络拓扑中能够正确定位。例如，一个多地址可能类似于：

```
/ip4/127.0.0.1/tcp/8080/http/my-image.png
```

这表示一个运行在本地机器（IP: 127.0.0.1）上、使用 TCP 协议、监听端口 8080 并提供 HTTP 服务的资源。
### 1.7 Security

libp2p 默认提供加密连接，确保所有节点之间的通信都是安全的。在 libp2p 中，对等节点的身份通过私钥生成的公钥进行验证，因此每个对等节点的连接都能得到加密保护。这种安全机制有效地防止了中间人攻击和未经授权的访问，保证了点对点通信的保密性和完整性。

### 1.8 Publish/Subscribe

libp2p 提供了一个高效的发布/订阅（Pub/Sub）系统，允许对等节点基于主题进行消息传递。在这种机制中，主题是用于分类和分发消息的抽象。每个主题类似于一个消息桶，节点可以订阅自己感兴趣的主题，从而接收到相关的消息。

## 2 Connecting Peers

### 2.1 Understanding Nodes

在 p2p 网络中的一个核心术语是节点。节点在软件工程中的概念相当广泛，但在 libp2p 中，它通常指网络中的一个单独对等体（基本上，是一台可能在 p2p 网络中发送或接收消息的计算机）。例如下面代码就使用了默认设置创建了一个节点：

```go
host, err := libp2p.New()
```

节点与其他节点建立连接，因此我们需要一种定位这些节点的方法。多地址（Multiaddresses）指定节点的位置（例如，哪个 IP 地址和哪个端口），而对等标识符（peer identifiers）指定节点的身份（例如，一旦到达节点，你可以检查这是否确实是你要找的节点）。

### 2.2 Peer Identity

网络中的每个节点都通过其 peer id 唯一标识。peer id 是从节点的公钥生成的。peer id 是一个 multihash，本质上是一个哈希值，前面带有使用的哈希算法（与 CIDs 中使用的 multihashes 方式相同）。
- 如果公钥的长度超过 42 字节，则通过将哈希函数应用于公钥来生成 multihash 摘要。
- 如果公钥的长度小于或等于 42 字节，则 multihash 摘要是公钥本身，且哈希函数代码是 identity hash。identity hash 表示输出的摘要与输入相同。

### 2.3 Multiaddress

我们通过每个节点的公钥唯一标识每个节点，但是，我们仍然必须知道在哪里以及如何建立连接。多地址允许你指定连接的传输方式（TCP、UDP、QUIC…）以及如何到达节点以建立连接（IP、DNS…）。

多地址的主要优点是它们是自描述的。仅通过查看地址，你就可以知道连接中涉及了哪些协议。

### 2.4 Establishing a connection

现在我们知道了如何联系我们的对等方，我们可以创建一个连接。当我们在 libp2p 中创建连接时，会发生一个称为连接引导的过程。这个过程负责：
- 握手：与对等方建立原始连接。
- 安全协议: 协商用于原始连接的安全协议（例如 TLS）。
- 流复用器: 协商流复用器协议。

请注意，libp2p 不允许未加密或未复用的连接。在建立连接时，我们将有两个角色：发起者和响应者。

### 2.5 Handshake

握手开始与对等方的连接，并验证对等方能否理解 multistream-select 协议。

握手之后，两个对等方必须协商其他协议（安全、多路复用器、应用等），所以我们需要一个协议来指示两个对等方如何协商其他协议。Multistream 协议允许对等方交换他们支持的其他协议并进行协商。因此，两个对等方必须同意使用同一版本的 Multistream。

```
# Request: Do you understand "/multistream/1.0.0"? 
> /multistream/1.0.0 
 
# Response: I do. 
+ /multistream/1.0.0
```

### 2.6 Security

现在，两个对等方将使用 Multistream 协商安全协议，这允许连接被加密。

