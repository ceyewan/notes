![28eaba880a36903159b12d5c5becd8f4.png](https://ceyewan.oss-cn-beijing.aliyuncs.com/typora/28eaba880a36903159b12d5c5becd8f4.png)

这个图是签名图，签名才需要在线系统把交易的哈希值传入离线系统，离线系统签名完成后再传出给在线系统。如果是创建案件或者密钥生成，只需要在离线系统进行操作。（不需要上链的都不用涉及在线系统）。

接下来我写的是**签名生成**的流程。我写的第几步对应你圆圈里的数字。
1. 第一步：**授权用户**输入 $(fromAddr,toAddr,Amount)$，表示 A 要给 B 转多少钱。（登录过程我省略了）
3. 第二步：服务器打包交易数据并对其进行哈希运算，返回 $(Hash,fromAddr)$ 给用户。将 $(fromAddr, TxData, Hash)$ 存储在 $TxTable$ 表中。这里主要用到的是交易表，和用户表关系不大。
4. 第五步：授权用户将 $(Hash,fromAddr)$ 通过物理介质拷贝到离线系统（也就是图里的浏览器，但是这个东西也可以集成到我们的客户端上）
6. 第六步：离线系统的系统管理员输入 $(Hash,fromAddr)$ 到 Server（也是省略了登录认证过程）
8. 第九步：服务器根据 fromAddr，会找到管理这个地址的三个案件管理员和对应的三个安全芯片，和分别对应的数据。创建 $signTable$ 表 $(randNum_i，fromAddr，hash，userId_i，SN_i，normalData，parties，i)$。$i$ 表示参与方编号。
9. 没标的：服务器给案件管理员 $userId_i$ 发送通知，通知内容为 $randNum_i$。
10. 第七步：**案件管理员**登录 $Client$，除 $userID$ 和 $PIN$ 外，还需要需要携带 $randNum_i$。
11. 第八步：Client 和 Server 建立安全通道后，将 $randNum_i$ 发送回 Server。
12. 第十步：Server 端首先验证 userID，SN 是不是和 signTable 中的一致，然后发送 (hash，normalData,i) 到 Client，并将 SE 上对应的私钥分片设为可用。
13. 第十一步：normalData + secretData => Data，使用数据 (hash， parties，i, Data) 进行签名。
14. 第十二步：Client 发送 randNum_i，sign 给 Server。
15. 加一步：Server 通过 randNum_i 从 signTable 中找到 fromAddr，打包数据 (sign, fromAddr) 给 Browser。
16. 第五步：用户将 (sign，fromAddr) 通过物理介质拷贝到在线系统的 Browser。
17. 第三步：授权用户将 (sign，fromAddr) 发送到 Server 上，Server 查找 TransferTable 获取 data，将交易上链。
18. 第四步：交易成功/失败。
