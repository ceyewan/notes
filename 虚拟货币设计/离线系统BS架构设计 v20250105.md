# 系统整体架构设计

该系统采用了一种分层的安全架构，将在线操作和离线敏感操作严格分离，以最大程度地保护用户的资产安全。

## 在线系统架构（B/S 架构）

用户通过浏览器访问在线系统，完成注册、登录、账户信息查询、发起交易等操作。在线系统提供直观的用户界面，并通过 API 与后端进行交互。

### **用户管理模块**：

 负责用户身份认证与权限管理，支持用户注册、登录、角色分配和状态管理。角色包括：

-   **普通用户**：仅可查询账户信息。
-   **授权用户**：可发起交易请求（如余额查询、转账等）。
-   **审计用户**：专注于日志查看与监控。
-   **系统管理员**：负责系统维护与用户权限分配。

### **交易模块**：

-   授权用户发起交易请求（如余额查询、转账等）。
-   在线系统生成交易数据和交易哈希值，并返回给用户。
-   用户将 **交易哈希值** 和 **账户地址** 安全拷贝到离线系统，由离线系统完成签名操作。
-   离线系统签名完成后，用户将 **签名数据** 和 **账户地址** 安全拷贝回在线系统，由在线系统完成交易的广播上链。

### **审计模块**：

 审计用户可查看系统操作日志和交易日志，用于监控用户行为与系统运行状态，满足合规性要求。

### 数据库设计

**用户表（users）：**

存储用户的基本信息与权限控制，支持角色和状态管理。

```
- id (主键): 用户唯一标识
- username: 用户名
- password_hash: 密码哈希值
- role: 用户角色（普通用户、授权用户、审计用户、管理员）
- status: 用户状态（启用、禁用）
- created_at: 创建时间
- updated_at: 更新时间
```

**账户表（accounts）：**

存储用户区块链账户信息。

```
- id (主键): 账户唯一标识
- address: 区块链账户地址
- balance: 当前余额（定期同步区块链）
- created_at: 创建时间
- updated_at: 更新时间
```

**交易表（transactions）：**

存储交易记录，便于操作追踪与审计。

```
- id (主键): 交易唯一标识
- user_id (外键): 发起交易的用户
- account_id (外键): 交易关联的账户
- tx_hash: 交易哈希值（由在线系统生成）
- tx_data: 交易数据（如转账金额、目标地址等）
- signature: 签名数据（由离线系统生成并返回）
- status: 交易状态（待签名、已签名、已上链）
- created_at: 创建时间
- updated_at: 更新时间
```

**日志表（logs）：**

存储系统操作日志和交易日志，供审计模块使用。

```
- id (主键): 日志唯一标识
- user_id (外键): 操作用户
- action: 操作类型（如登录、查询、发起交易等）
- details: 操作详情
- created_at: 日志生成时间
```

### 核心操作交互步骤

1.  **注册与登录**：
    -   用户通过浏览器访问在线系统，完成注册或登录。
    -   登录后，系统根据用户角色展示不同功能模块。
2.  **账户查询**：
    -   用户可查询账户的地址、余额等信息，余额数据通过区块链接口定期同步。
3.  **交易发起与签名流程**：
    -   授权用户填写交易信息（如目标地址、金额等）。
    -   在线系统生成交易数据和对应的交易哈希值，并返回给用户。
    -   用户将 **交易哈希值** 和 **账户地址** 复制到离线系统，由离线系统完成签名操作。
    -   离线系统生成签名后，用户将 **签名数据** 和 **账户地址** 复制回在线系统。
    -   在线系统校验签名后，完成交易的广播上链，并更新交易状态为 **已上链**。
4.  **日志审计**：
    -   审计用户通过审计模块查看操作日志和交易日志。

## 离线系统架构

离线系统是整个系统的核心安全模块，负责密钥的生成、分片管理、门限签名以及案件和用户的管理。系统通过 **B/S 架构** 和 **C/S 架构** 的结合，确保安全性、灵活性和可扩展性。

###  B/S 架构部分

B/S 架构主要用于案件管理、用户管理和安全芯片(SE)管理等功能，提供基于 Web 的交互界面，供系统管理员和审计管理员使用。

-   **用户管理**: 支持用户注册、登录、角色分配和权限管理。包括以下用户：
    -   **系统管理员**：负责全局管理，包括案件管理、用户管理和 SE 管理。

    -   **案件管理员**：负责案件的具体操作（通过 C/S 架构的 Client 端）。
    -   **审计管理员**：负责查看日志和记录审计。
    -   **普通用户**：仅可查看有限信息，不参与关键操作。

-   **案件管理**
    -   系统管理员可创建、删除案件，分配案件管理员。
    -   每个案件对应一个或多个虚拟货币账户，支持多管理员管理。
    -   案件管理员无需登录 Web 界面，操作通过 C/S 架构完成。
-   **安全芯片(SE)管理**
    -   添加新的 SE：系统管理员通过 Web 界面插入 SE，读取其 CID 和 SN，将其与数据库建立映射关系。
    -   支持批量录入 SE 的 CID 和 SN，对应关系存储在后台数据库中。
    -   提供 SE 的状态管理功能，包括启用、禁用和最后使用时间的记录。

### C/S 架构部分

C/S 架构负责执行密钥生成、门限签名等高安全性操作，确保私钥分片的安全隔离。案件管理员通过 Client 端与 Server 端协同完成操作。

-   **Client 端**
    -   案件管理员使用，插入分配的 SE，通过 APDU 命令读取 CID，并与 Server 端建立安全通信通道。
    -   负责执行密钥生成和签名操作，所有私钥分片直接存储在 SE 中，不在外部暴露。
    -   提供用户登录功能，登录时需验证 SE 的 CID 是否与 SN 匹配。
-   **Server 端**
    -   运行门限签名算法，协调多个 Client 端完成签名过程。
    -   提供身份验证功能，通过 HSM 验证 Client 端用户和 SE 的合法性。
    -   记录密钥生成和签名的状态，并更新数据库中的映射关系。

### 数据库设计

1.  **用户表 (users)**: 存储系统用户的信息，包括用户名、密码哈希（加盐 fp）、角色（管理员、案件管理员、普通用户）和状态。
2.  **案件表 (cases)**: 存储案件的基本信息，如案件名称、状态、公钥地址、门限签名所需的总份数和最小签名数。
3.  **安全芯片表 (secure_elements)**: 存储安全芯片的信息，如序列号、状态和最后使用时间。
4.  **私钥分片映射表 (key_shard_mappings)**: 存储私钥分片与案件、安全芯片、用户的映射关系，包括公钥、分片编号、安全芯片 ID、当前持有人和状态。

### 核心操作步骤

#### 创建案件

1.   系统管理员登录离线系统的 Web 端。

2.   在案件管理界面，创建一个新的案件，填写案件名称等基本信息。
3.   系统管理员为该案件分配 3 个案件管理员，并为每个管理员分配一个安全芯片编号，用于下一步使用。
4.   案件管理员收到通知后，登录各自的 Client 端，插入分配的安全芯片。
5.   Client 端检测到安全芯片后，与安全芯片建立安全的通信通道并发送自己的用户名和密码，安全芯片与 Server 端的 HSM 建立安全的通信通道。
6.   Server 验证用户名和密码，将验证通过后将返回签名给 Client 端，Client 等待执行。
7.   Client 端执行密钥生成 (keygen) 过程，私钥分片直接保存在安全芯片中，将公钥传回 Server 端。
8.   系统自动更新 `key_shard_mappings` 表，记录私钥分片与案件、安全芯片、案件管理员的对应关系。
9.   系统将生成的公钥地址绑定到案件。

#### 变更案件管理员

1.  系统管理员登录离线系统的 Web 端。
2.  在案件管理界面，选择需要变更管理员的案件。
3.  系统管理员选择待替换的案件管理员，并分配一个新的案件管理员。
4.  系统更新 `key_shard_mappings` 表，将原案件管理员的 `user_id` 更新为新的案件管理员。
5.  系统自动废除原案件管理员的访问权限。
6.  系统通知新的案件管理员完成交接。

#### 转账交易

1.  授权用户登录在线系统。
2.  在交易模块，选择源账户，输入目标地址和金额。
3.  在线系统打包交易信息，生成交易哈希值。
4.  授权用户携带交易哈希值和账户地址访问离线系统。
5.  离线系统 Web 端查询账户地址对应的案件信息。
6.  系统通知该案件的至少 2 个案件管理员，告知需要使用的安全芯片编号。
7.  案件管理员收到通知后，插入对应的安全芯片，登录 Client 端。
8.  Client 端验证安全芯片序列号，并与 Server 端的 HSM 建立安全通道。
9.  Client 端执行门限签名流程，Server 端协调多个 Client 端完成签名。
10.  签名完成后，关闭安全通道。
11.  离线系统生成完整的交易签名。
12.  授权用户将签名提交回在线系统。
13.  在线系统广播签名交易到区块链网络。
14.  系统记录交易日志。