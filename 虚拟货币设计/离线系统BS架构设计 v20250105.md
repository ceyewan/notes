# 系统整体架构设计

该系统采用了一种分层的安全架构，将在线操作和离线敏感操作严格分离，以最大程度地保护用户的资产安全。

## 在线系统架构（B/S 架构）

用户通过浏览器访问在线系统，完成注册、登录、账户信息查询、发起交易等操作。在线系统提供直观的用户界面，并通过 API 与后端进行交互。

### **用户管理模块**：

 负责用户身份认证与权限管理，支持用户注册、登录、角色分配和状态管理。角色包括：

-   **普通用户**：仅可查询账户信息。
-   **授权用户**：可发起交易请求（如余额查询、转账等）。
-   **审计用户**：专注于日志查看与监控。
-   **系统管理员**：负责系统维护与用户权限分配。

### **交易模块**：

-   授权用户发起交易请求（如余额查询、转账等）。
-   在线系统生成交易数据和交易哈希值，并返回给用户。
-   用户将 **交易哈希值** 和 **账户地址** 安全拷贝到离线系统，由离线系统完成签名操作。
-   离线系统签名完成后，用户将 **签名数据** 和 **账户地址** 安全拷贝回在线系统，由在线系统完成交易的广播上链。

### **审计模块**：

 审计用户可查看系统操作日志和交易日志，用于监控用户行为与系统运行状态，满足合规性要求。

### 数据库设计

**用户表（users）：**

存储用户的基本信息与权限控制，支持角色和状态管理。

```
- id (主键): 用户唯一标识
- username: 用户名
- password_hash: 密码哈希值
- role: 用户角色（普通用户、授权用户、审计用户、管理员）
- status: 用户状态（启用、禁用）
- created_at: 创建时间
- updated_at: 更新时间
```

**账户表（accounts）：**

存储用户区块链账户信息。

```
- id (主键): 账户唯一标识
- address: 区块链账户地址
- balance: 当前余额（定期同步区块链）
- created_at: 创建时间
- updated_at: 更新时间
```

**交易表（transactions）：**

存储交易记录，便于操作追踪与审计。

```
- id (主键): 交易唯一标识
- user_id (外键): 发起交易的用户
- account_id (外键): 交易关联的账户
- tx_hash: 交易哈希值（由在线系统生成）
- tx_data: 交易数据（如转账金额、目标地址等）
- signature: 签名数据（由离线系统生成并返回）
- status: 交易状态（待签名、已签名、已上链）
- created_at: 创建时间
- updated_at: 更新时间
```

**日志表（logs）：**

存储系统操作日志和交易日志，供审计模块使用。

```
- id (主键): 日志唯一标识
- user_id (外键): 操作用户
- action: 操作类型（如登录、查询、发起交易等）
- details: 操作详情
- created_at: 日志生成时间
```

### 核心操作交互步骤

1.  **注册与登录**：
    -   用户通过浏览器访问在线系统，完成注册或登录。
    -   登录后，系统根据用户角色展示不同功能模块。
2.  **账户查询**：
    -   用户可查询账户的地址、余额等信息，余额数据通过区块链接口定期同步。
3.  **交易发起与签名流程**：
    -   授权用户填写交易信息（如目标地址、金额等）。
    -   在线系统生成交易数据和对应的交易哈希值，并返回给用户。
    -   用户将 **交易哈希值** 和 **账户地址** 复制到离线系统，由离线系统完成签名操作。
    -   离线系统生成签名后，用户将 **签名数据** 和 **账户地址** 复制回在线系统。
    -   在线系统校验签名后，完成交易的广播上链，并更新交易状态为 **已上链**。
4.  **日志审计**：
    -   审计用户通过审计模块查看操作日志和交易日志。

## 离线系统

离线系统是整个系统的核心，负责私钥的安全管理和交易签名。它分为 Web 端 (B/S 架构) 和门限签名系统 (C/S 架构) 两部分。

### B/S 架构

-   **用户管理**: 负责用户的注册、登录、权限管理。管理案件管理员的信息。

-   **案件管理**: 创建、删除和变更案件，每个案件对应一个或多个虚拟货币账户。

-   **用户交互**: 系统管理员通过 Web 界面管理案件和案件管理员。

### C/S 架构

负责运行整个门限签名系统，案件管理员使用 Client 端，通过 ECKA 建立安全通道与 Server 端通信。存储了私钥分片和门限签名算法的安全芯片插在 Client 端的电脑上，案件管理员通过 Server 端的 HSM 验证了其身份后，可以获得私钥分片的使用权。之后，在收到 Server 发来的消息之后，执行密钥生成或签名。

-   **Client 端**: 案件管理员使用，负责与 Server 端通信，进行密钥生成和签名。

-   **Server 端**: 运行门限签名算法的 Manger，负责协调多个 Client 端的签名过程。此外，Server 还可与 B/S 架构协同，验证身份，管理状态。

# 数据库设计

在线系统数据库：

1.   用户表（users）：存储系统用户的信息，包括用户名、密码哈希、角色（管理员、授权用户、审计用户、普通用户）和状态等信息。
2.   账户表（accounts）：存储账户的地址、余额、创建时间等。

离线系统数据库：

1.  **用户表 (users)**: 存储系统用户的信息，包括用户名、密码哈希（加盐 fp）、角色（管理员、案件管理员、普通用户）和状态。

2.  **案件表 (cases)**: 存储案件的基本信息，如案件名称、状态、公钥地址、门限签名所需的总份数和最小签名数。

3.  **安全芯片表 (secure_elements)**: 存储安全芯片的信息，如序列号、状态和最后使用时间。

4.  **私钥分片映射表 (key_shard_mappings)**: 存储私钥分片与案件、安全芯片、用户的映射关系，包括公钥、分片编号、安全芯片 ID、当前持有人和状态。

5.  **签名会话表 (signing_sessions)**: 存储签名会话的信息，如案件 ID、交易哈希、状态、所需签名数和当前签名数。

6.  **签名参与记录表 (signing_participants)**: 存储签名参与者的信息，如会话 ID、用户 ID、分片编号、安全芯片 ID、状态和签名时间。

7.  **安全通道日志表 (security_channel_logs)**: 存储安全通道的建立和关闭日志，包括安全芯片 ID、通道 ID、状态和错误信息。

# 核心操作步骤

## 创建案件

1.   系统管理员登录离线系统的 Web 端。

2.   在案件管理界面，创建一个新的案件，填写案件名称等基本信息。
3.   系统管理员为该案件分配 3 个案件管理员，并为每个管理员分配一个安全芯片编号，用于下一步使用。
4.   案件管理员收到通知后，登录各自的 Client 端，插入分配的安全芯片。
5.   Client 端检测到安全芯片后，与安全芯片建立安全的通信通道并发送自己的用户名和密码，安全芯片与 Server 端的 HSM 建立安全的通信通道。
6.   Server 验证用户名和密码，将验证通过后将返回签名给
7.   Client 端执行密钥生成 (keygen) 过程，私钥分片直接保存在安全芯片中。
8.   系统自动更新 `key_shard_mappings` 表，记录私钥分片与案件、安全芯片、案件管理员的对应关系。
9.   系统将生成的公钥地址绑定到案件。