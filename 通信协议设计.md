## 通信设计

我们项目的通信协议设计基于双层开发板架构，通过优化 CCID 协议栈和扩展 APDU 指令集实现高效、安全的数据交换。系统上层安全芯片和下层的 STM32 微控制器通过 SPI 通信，下层芯片与主机通过 USB 使用 CCID 协议通信。

我们在 STM32 上实现了完整的 CCID 协议栈，支持主机通过标准化的 USB 接口与 STM32 进行通信。主机生成的 APDU 指令以 CCID 格式封装，通过 USB 发送到 STM32。STM32 接收后，将指令通过 SPI 转发至上层安全芯片。安全芯片解析指令后，完成相应的密码操作（如密钥生成、签名或加密），将结果封装为 APDU 响应数据，依次通过 SPI 和 CCID 协议返回至主机。

为支持后量子密码操作，我们设计了一套专用的拓展 APDU 指令集。每条指令通过字段精确指定操作类别、算法类型和数据负载，确保兼容性与灵活性。例如：

-   密钥生成（Kyber、Dilithium 等）：通过 P1、P2 参数指定算法与操作模式，返回公私钥对。
-   签名与验证：支持动态加载消息内容并返回签名结果或验证状态。
-   数据加解密：支持指定明文或密文，返回计算结果。
-   持久化操作：支持 RAM 与 FLASH 之间的公私钥数据迁移。

并以 SW 状态字（如 9000 表示成功，6A85 表示失败）标记每条指令的执行结果，增强了指令解析的容错能力。

| **类型**      | **命令 APDU 最大长度** | **响应 APDU 最大长度** |
| ------------- | ---------------------- | ---------------------- |
| **短 APDU**   | 261 字节               | 258 字节               |
| **扩展 APDU** | 65545 字节             | 65538 字节             |

## 创新点

CCID 与 SPI 协议无缝集成，并通过 APDU 细化操作，可以支持多种后量子密码算法和参数的动态切换。此外，CCID 协议栈、SPI 通信和算法处理相互解耦，便于以后扩展和维护。

![image-20241126201631399](https://ceyewan.oss-cn-beijing.aliyuncs.com/typora/image-20241126201631399.png)

![image-20241126203147711](https://ceyewan.oss-cn-beijing.aliyuncs.com/typora/image-20241126203147711.png)