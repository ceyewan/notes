## 1 大数据存储查询设计

**问题**：每天 TB 级玩家行为日志，需数据库存储并支持按时间段、玩家 ID 等条件快速查询。

**分析**：应对海量数据、高效索引和查询性能挑战。需分布式系统。

> [!NOTE] 数据库选型
> MySQL，基于 B+ 树，适用于读多写少，不适合海量数据，不适用于本场景；
> LevelDB，基于 LSM 树的 KV 键值对数据库，适用于写多读少，不支持 SQL，不行；
> InfluxDB，TSDB 时间序列结构，写入快，支持时序查询，适合日志类应用；
> ES：倒排索引 +LSM-Tree，内存占用高，适合日志全文检索，查询性能不如 TSDB。

**总体思路**：分层设计：数据采集、数据存储、索引与查询、扩展运维。

### 1.1 数据采集层

日志是实时产生的，需要低延迟、高吞吐量的写入通道，同时避免单点瓶颈。

- 使用分布式消息队列（如 Kafka）缓冲实时日志。
- 日志按（时间 + 玩家 ID）哈希分散到主题/分区。
- 日志包含：玩家 ID、时间戳、行为类型、附加数据（JSON）。

**优化**：批量写入、消息队列持久化。

### 1.2 数据存储层

TB 级数据需要分布式存储，结合时间序列和玩家 ID 的查询特点，选择合适的存储引擎。

- 选用分布式时间序列数据库，适合时间段查询。
- 数据按时间分区存储在分布式节点。
- 字段：时间戳（主键）、玩家 ID、行为数据。

**优化**：冷热分离（SSD、HDFS）、数据分片、预聚合、内存缓冲、异步批量写入。

### 1.3 索引与查询层

快速查询需要高效索引，时间段和玩家 ID 是主要条件，要针对这两种模式优化。

- 时间序列数据库自带时间索引，高效查询时间范围。
- 构建二级索引：分布式 KV 存储（Redis）维护玩家 ID 到时间戳的映射。

**优化**：缓存热点数据、异步更新索引。

### 1.4 拓展运维层

系统需支持数据增长和高可用，同时便于维护。

- **水平扩展**：存储和索引节点动态扩容，自动分配分片。
- **高可用**：数据多副本存储，分布在不同节点，容忍单点故障。
- **监控优化**：监控延迟、吞吐量，动态调整分片或资源。

**核心**：分而治之，多层次优化。

- **分而治之**：采集、存储、查询分层。
- **优化重点**：复合分区负载均衡，批量写入减压，索引加速查询。
- **结果**：高效支持 TB 级存储与亿级日活查询。
