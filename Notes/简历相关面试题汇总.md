## 1 分布式微服务即时通讯系统

在这个分布式微服务即时通讯系统的设计中，我采用了四层架构，分别包括 **API 层**、**Logic 层**、**Task 层** 和 **Connect 层**。为了提升系统的性能和可扩展性，我在 **Logic 层** 和 **Connect 层** 分别实现了 RPC 服务器，分别称为 **LogicRPC** 和 **ConnectRPC**。系统支持单聊消息和群聊消息。

首先，**API 层** 基于 **Gin** 框架，作为系统的 HTTP 入口，负责处理用户登录、注册等请求。这些请求通过 **gRPC** 调用 **LogicRPC**，由 **Logic 层** 处理具体的业务逻辑。**Logic 层** 不仅负责用户认证和消息处理，还通过 **Redis** 维护用户状态，并利用 **Redis Stream** 作为高吞吐量的消息队列，实现实时消息的投递与存储分离。

在 **Task 层**，我实现了两种消息处理逻辑：一个消费者组通过调用 **ConnectRPC**，将消息及时投递到 **Connect 层**，确保消息的低延迟推送；另一个消费者组则异步读取消息，并将其持久化到 **MySQL** 中，保证数据的可靠性。

**Connect 层** 通过 **WebSocket** 与用户建立长连接，确保消息的低延迟推送。当用户登录后，系统会与 **Connect 层** 建立 WebSocket 长连接。**Connect 层** 通过 **LogicRPC** 进行用户状态管理，确保消息的精准投递。**Task 层** 从 **Redis Stream** 读取消息后，通过 **ConnectRPC** 将消息投递到 **Connect 层**，并最终推送给用户。

为了增强系统的可扩展性，我采用了 **etcd** 进行动态服务发现，支持集群的扩展与自动负载均衡。同时，系统基于 **Docker Compose** 进行容器化部署，确保弹性伸缩和高效的资源利用。

最终，该系统能够支持 **5W+ QPS**，消息投递延迟稳定在 **50ms** 以内，并具备秒级故障恢复能力，能够高效满足大规模用户的实时通讯需求。

Q：为什么要实现四层架构？你有什么考量？
1. 职责分离与模块化
2. 性能优化与高可用性
3. 开发与部署灵活
4. 后续扩展，如 Task 层增加消息批量处理、延迟投递、消息审计监控功能；Logic 层增加消息撤回、已读回执功能。

Q：如何实现消息撤回、已读回执？


Q：如何确保消息唯一的投递？

首先，将消息使用 murmurhash 哈希，将 userID+hash 作为 key 存储到 redis 里，设置过期时间，当再次收到消息时，先检查 Redis，是否有重复 key。没有的话，将消息使用雪花算法生成一个分布式的唯一 ID，再投递到消息队列，后续通过消息队列和这个唯一 ID 来确保唯一性。



