## 1 分布式微服务即时通讯系统

在这个分布式微服务即时通讯系统的设计中，我采用了四层架构，分别包括 **API 层**、**Logic 层**、**Task 层** 和 **Connect 层**。为了提升系统的性能和可扩展性，我在 **Logic 层** 和 **Connect 层** 分别实现了 RPC 服务器，分别称为 **LogicRPC** 和 **ConnectRPC**。系统支持单聊消息和群聊消息。

首先，**API 层** 基于 **Gin** 框架，作为系统的 HTTP 入口，负责处理用户登录、注册等请求。这些请求通过 **gRPC** 调用 **LogicRPC**，由 **Logic 层** 处理具体的业务逻辑。**Logic 层** 不仅负责用户认证和消息处理，还通过 **Redis** 维护用户状态，并利用 **Redis Stream** 作为高吞吐量的消息队列，实现实时消息的投递与存储分离。

在 **Task 层**，我实现了两种消息处理逻辑：一个消费者组通过调用 **ConnectRPC**，将消息及时投递到 **Connect 层**，确保消息的低延迟推送；另一个消费者组则异步读取消息，并将其持久化到 **MySQL** 中，保证数据的可靠性。

**Connect 层** 通过 **WebSocket** 与用户建立长连接，确保消息的低延迟推送。当用户登录后，系统会与 **Connect 层** 建立 WebSocket 长连接。**Connect 层** 通过 **LogicRPC** 进行用户状态管理，确保消息的精准投递。**Task 层** 从 **Redis Stream** 读取消息后，通过 **ConnectRPC** 将消息投递到 **Connect 层**，并最终推送给用户。

为了增强系统的可扩展性，我采用了 **etcd** 进行动态服务发现，支持集群的扩展与自动负载均衡。同时，系统基于 **Docker Compose** 进行容器化部署，确保弹性伸缩和高效的资源利用。

最终，该系统能够支持 **5W+ QPS**，消息投递延迟稳定在 **50ms** 以内，并具备秒级故障恢复能力，能够高效满足大规模用户的实时通讯需求。

Q：为什么要实现四层架构？你有什么考量？
1. 职责分离与模块化
2. 性能优化与高可用性
3. 开发与部署灵活
4. 后续扩展，如 Task 层增加消息批量处理、延迟投递、消息审计监控功能；Logic 层增加消息撤回、已读回执功能。

Q：如何确保消息唯一的投递？

- **使用 MurmurHash 哈希消息内容**，将 `userID + hash` 作为 Redis 的 key，并设置过期时间。
- **检查 Redis 中的重复 key**，如果存在，则判定为重复消息，拒绝投递。
- **生成分布式唯一 ID**，使用雪花算法为消息生成唯一 ID，确保消息在分布式系统中的唯一性。
- **投递到支持消息去重的消息队列**，如 Kafka 或 RabbitMQ 的幂等性生产者，配置消息的唯一 ID，防止重复投递。
- **增加幂等性检查**，在处理消息前，检查 MySQL 中是否已记录该消息 ID，确保消息只被处理一次。
- **结合 Redis 和消息队列**，通过双重机制确保消息的唯一投递和幂等性处理。

Q：有哪些应对高并发、提高容错率的办法？

- etcd 服务动态注册和发现，k8s 弹性伸缩
- 健康检查：心跳机制、HTTP 健康检查接口
- 熔断降级：当服务调用失败率达到阈值时，触发熔断，直接返回降级结果（默认值）
- 令牌桶限流：限制单位时间内的请求量，超出限制的请求被拒绝或排队。
- 负载均衡策略：一致性哈希、结合服务监控选择最佳服务实例来提供服务
- 服务监控、日志分析（普罗米修斯、ELK 等）：实时监控系统性能，分析日志定位问题。
- 消息队列：将操作异步化，减少请求响应时间，流量削峰。

**ELK** 是一个流行的日志管理和分析技术栈，由三个开源工具组成：

1. **Elasticsearch**：分布式搜索和分析引擎，用于存储和快速检索日志数据。
2. **Logstash**：数据收集和处理管道，用于接收、解析和转换日志数据。
3. **Kibana**：数据可视化工具，用于在 Web 界面中展示和分析日志数据。

Q：性能瓶颈分析？

1. 消息的反复序列化与反序列化
2. 内存、CPU 资源的竞争
3. RPC 调用的性能瓶颈，流式调用、负载均衡

