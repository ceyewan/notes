## 1 Select 语句分析

### 1.1 MySQL 执行流程

![image.png](https://ceyewan.oss-cn-beijing.aliyuncs.com/typora/20250317104826.png)

MySQL 的架构共分为两层：**Server 层和存储引擎层**，

- **Server 层负责建立连接、分析和执行 SQL**。MySQL 大多数的核心功能模块都在这实现，主要包括连接器，查询缓存、解析器、预处理器、优化器、执行器等。另外，所有的内置函数（如日期、时间、数学和加密函数等）和所有跨存储引擎的功能（如存储过程、触发器、视图等。）都在 Server 层实现。
- **存储引擎层负责数据的存储和提取**。支持 InnoDB、MyISAM、Memory 等多个存储引擎，不同的存储引擎共用一个 Server 层。现在最常用的存储引擎是 InnoDB，从 MySQL 5.5 版本开始， InnoDB 成为了 MySQL 的默认存储引擎。我们常说的索引数据结构，就是由存储引擎层实现的，不同的存储引擎支持的索引类型也不相同，比如 InnoDB 支持索引类型是 B+ 树 ，且是默认使用，也就是说在数据表中创建的主键索引和二级索引默认使用的是 B+ 树索引。

### 1.2 连接器

在使用 MySQL 之前，需要先连接到 MySQL 服务，通常使用的命令为：

```go
mysql -h$ip -u$user -p
```

连接会先经过 TCP 三次握手，然后验证用户名和密码，最后获取当前用户的权限并保存，因此，如果中途修改了权限，也不会立即生效。
可以使用 show processlist 查看当前 MySQL 服务被多少个客户端连接了。如果一行数据的 Command 为 Sleep，说明这是一个空闲连接。如果空闲时长超过 MySQL 定义的空闲连接的最大空闲时长，连接器就会自动断开这个连接。
解决大量的长连接占用内存的问题：
1. 定期断开长连接。
2. 客户端主动重置连接，使用 mysql_reset_connection() 函数
